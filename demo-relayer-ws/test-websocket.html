<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Room Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-bottom: 20px;
        }
        input, button, textarea {
            margin: 5px;
            padding: 8px;
        }
        #messages {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>WebSocket Room Test</h1>
    
    <div class="container">
        <h3>Connection</h3>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn">Disconnect</button>
        <div id="status" class="status disconnected">Disconnected</div>
    </div>
    
    <div class="container">
        <h3>Room Operations</h3>
        <input type="text" id="roomInput" placeholder="Room name" value="test-room">
        <button id="joinBtn">Join Room</button>
        <button id="leaveBtn">Leave Room</button>
    </div>
    
    <div class="container">
        <h3>Send Message</h3>
        <input type="text" id="recipientInput" placeholder="Recipient ID (for signaling)">
        <select id="messageType">
            <option value="offer">Offer</option>
            <option value="answer">Answer</option>
            <option value="ice-candidate">ICE Candidate</option>
            <option value="custom">Custom Message</option>
        </select>
        <textarea id="messageInput" placeholder="Message payload (JSON)"></textarea>
        <button id="sendBtn">Send</button>
    </div>
    
    <div class="container">
        <h3>Messages</h3>
        <div id="messages"></div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;

        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const sendBtn = document.getElementById('sendBtn');
        const messagesEl = document.getElementById('messages');

        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        connectBtn.addEventListener('click', () => {
            if (isConnected) return;
            
            const port = window.location.port || 8081;
            const wsUrl = `ws://localhost:${port}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                isConnected = true;
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
                addMessage('Connected to WebSocket server');
            };
            
            ws.onmessage = (event) => {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                addMessage(`Received: ${JSON.stringify(data)}`);
                
                // Handle specific message types
                if (data.type === 'existing-users') {
                    addMessage(`Existing users in room: ${data.payload.peers.join(', ') || 'none'}`);
                } else if (data.type === 'new-user') {
                    addMessage(`New user joined: ${data.payload.peerId}`);
                } else if (data.type === 'user-left') {
                    addMessage(`User left: ${data.payload.peerId}`);
                }
            };
            
            ws.onclose = () => {
                isConnected = false;
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                addMessage('Disconnected from WebSocket server');
            };
            
            ws.onerror = (error) => {
                addMessage(`WebSocket error: ${error}`);
            };
        });

        disconnectBtn.addEventListener('click', () => {
            if (ws) {
                ws.close();
            }
        });

        joinBtn.addEventListener('click', () => {
            const room = document.getElementById('roomInput').value;
            if (ws && isConnected) {
                ws.send(JSON.stringify({ type: 'join', payload: { room } }));
                addMessage(`Joining room: ${room}`);
            } else {
                addMessage('Please connect first');
            }
        });

        leaveBtn.addEventListener('click', () => {
            if (ws && isConnected) {
                ws.send(JSON.stringify({ type: 'leave-room', payload: null }));
                addMessage('Leaving room');
            } else {
                addMessage('Please connect first');
            }
        });

        sendBtn.addEventListener('click', () => {
            if (!ws || !isConnected) {
                addMessage('Please connect first');
                return;
            }

            const messageType = document.getElementById('messageType').value;
            const recipient = document.getElementById('recipientInput').value;
            const messageText = document.getElementById('messageInput').value;

            let payload = {};
            if (messageText) {
                try {
                    payload = JSON.parse(messageText);
                } catch (e) {
                    payload = { data: messageText };
                }
            }

            if (recipient) {
                payload.to = recipient;
            }

            const message = {
                type: messageType === 'custom' ? 'echo' : messageType,
                payload: payload
            };

            ws.send(JSON.stringify(message));
            addMessage(`Sent: ${JSON.stringify(message)}`);
        });
    </script>
</body>
</html>